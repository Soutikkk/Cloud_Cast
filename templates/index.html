<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌤️ CloudCast - Weather Logger</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-cloud-sun"></i>
                <span>🌤️ CloudCast</span>
            </div>
            <div class="nav-menu">
                <a href="#home" class="nav-link active">🏠 Home</a>
                <a href="#history" class="nav-link">📊 History</a>
                <a href="#graphs" class="nav-link">📈 Graphs</a>
                <a href="#map" class="nav-link">🗺️ Map</a>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Section -->
        <section id="home" class="section active">
            <div class="container">
                <h1 class="section-title">🌤️ Weather Logger</h1>
                <p class="section-subtitle">Track weather conditions and visualize data trends 📊</p>
                
                <!-- Weather Form -->
                <div class="weather-form-container">
                    <form id="weatherForm" class="weather-form">
                        <div class="form-group">
                            <label for="cityInput">Enter City Name</label>
                            <div class="input-group">
                                <input type="text" id="cityInput" name="city" placeholder="e.g., London, New York, Tokyo" required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    Get Weather
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Weather Alerts -->
                <div id="weatherAlerts" class="alerts-container" style="display: none;">
                    <h3>🚨 Weather Alerts</h3>
                    <div id="alertsList" class="alerts-list"></div>
                </div>

                <!-- Current Weather Display -->
                <div id="currentWeather" class="weather-display" style="display: none;">
                    <h3>🌡️ Current Weather</h3>
                    <div class="weather-card">
                        <div class="weather-info">
                            <div class="weather-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span id="currentCity"></span>
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-thermometer-half"></i>
                                <span id="currentTemp"></span>°C
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-tint"></i>
                                <span id="currentHumidity"></span>%
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-wind"></i>
                                <span id="currentWind"></span> m/s
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-clock"></i>
                                <span id="currentTime"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7-Day Forecast -->
                <div id="forecastSection" class="forecast-section" style="display: none;">
                    <h3>📅 7-Day Forecast</h3>
                    <div class="forecast-container">
                        <div id="forecastList" class="forecast-list"></div>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="download-section">
                    <button id="downloadBtn" class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Download Weather Data (CSV)
                    </button>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="history" class="section">
            <div class="container">
                <h2 class="section-title">📊 Weather History</h2>
                
                <!-- Filter Controls -->
                <div class="filter-container">
                    <h3>🔍 Filter History</h3>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="cityFilter">🏙️ Filter by City:</label>
                            <input type="text" id="cityFilter" placeholder="Enter city name...">
                        </div>
                        <div class="filter-group">
                            <label for="startDate">📅 From Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="filter-group">
                            <label for="endDate">📅 To Date:</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="filter-actions">
                            <button id="applyFilter" class="btn btn-primary">
                                <i class="fas fa-search"></i> Apply Filter
                            </button>
                            <button id="clearFilter" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear Filter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Clear History Button -->
                <div class="clear-history-section">
                    <button id="clearHistoryBtn" class="btn btn-danger">
                        <i class="fas fa-trash"></i> 🗑️ Clear All History
                    </button>
                </div>

                <div class="table-container">
                    <table class="weather-table">
                        <thead>
                            <tr>
                                <th>🏙️ City</th>
                                <th>🌡️ Temperature (°C)</th>
                                <th>💧 Humidity (%)</th>
                                <th>💨 Wind Speed (m/s)</th>
                                <th>📅 Date</th>
                                <th>🕐 Time</th>
                                <th>☁️ Description</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            {% for entry in weather_history %}
                            <tr>
                                <td>{{ entry.city }}</td>
                                <td>{{ entry.temperature }}</td>
                                <td>{{ entry.humidity }}</td>
                                <td>{{ entry.wind_speed }}</td>
                                <td>{{ entry.date }}</td>
                                <td>{{ entry.time }}</td>
                                <td>{{ entry.description or 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Graphs Section -->
        <section id="graphs" class="section">
            <div class="container">
                <h2 class="section-title">📈 Weather Data Visualization</h2>
                
                <!-- Graph Controls -->
                <div class="graph-controls">
                    <div class="form-group">
                        <label for="graphParameter">📊 Select Parameter to Graph:</label>
                        <select id="graphParameter" class="form-select">
                            <option value="temperature">🌡️ Temperature</option>
                            <option value="humidity">💧 Humidity</option>
                            <option value="wind_speed">💨 Wind Speed</option>
                        </select>
                        <button id="generateGraphBtn" class="btn btn-primary">
                            <i class="fas fa-chart-line"></i>
                            📈 Generate Graph
                        </button>
                    </div>
                </div>

                <!-- Graph Display -->
                <div id="graphContainer" class="graph-container">
                    <div id="graphPlaceholder" class="graph-placeholder">
                        <i class="fas fa-chart-line"></i>
                        <p>📊 Select a parameter and click "Generate Graph" to visualize your weather data</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section id="map" class="section">
            <div class="container">
                <h2 class="section-title">🗺️ Weather Map</h2>
                <p class="section-subtitle">📍 View all your logged weather locations on an interactive map</p>
                
                <div id="weatherMap" class="map-container"></div>
                <div class="map-controls">
                    <button id="refreshMapBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> 🔄 Refresh Map
                    </button>
                    <button id="centerMapBtn" class="btn btn-secondary">
                        <i class="fas fa-crosshairs"></i> 🎯 Center on Last City
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading weather data...</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
        <button id="notificationClose" class="notification-close">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.classList.add(savedTheme);
        updateThemeIcon(savedTheme);
        
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const currentTheme = body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon(currentTheme);
        });
        
        function updateThemeIcon(theme) {
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Navigation functionality
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                
                // Update active nav link
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Show target section
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetId) {
                        section.classList.add('active');
                    }
                });
            });
        });

        // Weather form submission
        const weatherForm = document.getElementById('weatherForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        
        weatherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cityInput = document.getElementById('cityInput');
            const city = cityInput.value.trim();
            
            if (!city) {
                showNotification('Please enter a city name', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('city', city);
                
                const response = await fetch('/fetch_weather', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('🌤️ Weather data saved successfully!', 'success');
                    displayCurrentWeather(result.data);
                    displayWeatherAlerts(result.alerts);
                    updateHistoryTable();
                    updateMap();
                    
                    // Store the last searched city
                    lastSearchedCity = city;
                    
                    // Center map on the entered city
                    if (weatherMap) {
                        await centerMapOnCity(city);
                    }
                    
                    // Fetch forecast
                    await fetchForecast(city);
                } else {
                    showNotification(result.error || 'Failed to fetch weather data', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        });
        
        function displayCurrentWeather(data) {
            document.getElementById('currentCity').textContent = data.city;
            document.getElementById('currentTemp').textContent = data.temperature;
            document.getElementById('currentHumidity').textContent = data.humidity;
            document.getElementById('currentWind').textContent = data.wind_speed;
            document.getElementById('currentTime').textContent = `${data.date} ${data.time}`;
            document.getElementById('currentWeather').style.display = 'block';
        }
        
        function displayWeatherAlerts(alerts) {
            const alertsContainer = document.getElementById('weatherAlerts');
            const alertsList = document.getElementById('alertsList');
            
            if (alerts && alerts.length > 0) {
                alertsList.innerHTML = '';
                alerts.forEach(alert => {
                    const alertElement = document.createElement('div');
                    alertElement.className = `alert alert-${alert.type}`;
                    alertElement.innerHTML = `
                        <i class="${alert.icon}"></i>
                        <span>${alert.message}</span>
                    `;
                    alertsList.appendChild(alertElement);
                });
                alertsContainer.style.display = 'block';
            } else {
                alertsContainer.style.display = 'none';
            }
        }
        
        async function fetchForecast(city) {
            try {
                const formData = new FormData();
                formData.append('city', city);
                
                const response = await fetch('/fetch_forecast', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayForecast(result.forecast);
                }
            } catch (error) {
                console.error('Error fetching forecast:', error);
            }
        }
        
        function displayForecast(forecast) {
            const forecastSection = document.getElementById('forecastSection');
            const forecastList = document.getElementById('forecastList');
            
            if (forecast && forecast.length > 0) {
                forecastList.innerHTML = '';
                forecast.forEach(day => {
                    const forecastCard = document.createElement('div');
                    forecastCard.className = 'forecast-card';
                    forecastCard.innerHTML = `
                        <div class="forecast-date">${day.date}</div>
                        <div class="forecast-time">${day.time}</div>
                        <div class="forecast-temp">${Math.round(day.temperature)}°C</div>
                        <div class="forecast-desc">${day.description}</div>
                        <div class="forecast-details">
                            <span>💧 ${day.humidity}%</span>
                            <span>💨 ${day.wind_speed} m/s</span>
                        </div>
                    `;
                    forecastList.appendChild(forecastCard);
                });
                forecastSection.style.display = 'block';
            }
        }
        
        async function updateHistoryTable() {
            try {
                const response = await fetch('/get_history');
                const data = await response.json();
                
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';
                
                data.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.city}</td>
                        <td>${entry.temperature}</td>
                        <td>${entry.humidity}</td>
                        <td>${entry.wind_speed}</td>
                        <td>${entry.date}</td>
                        <td>${entry.time}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error updating history table:', error);
            }
        }
        
        // Download CSV functionality
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.addEventListener('click', () => {
            window.location.href = '/download_csv';
        });
        
        // Clear history functionality
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        clearHistoryBtn.addEventListener('click', async () => {
            if (confirm('🗑️ Are you sure you want to clear all weather history? This action cannot be undone.')) {
                try {
                    const response = await fetch('/clear_history', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('🗑️ Weather history cleared successfully!', 'success');
                        updateHistoryTable();
                        updateMap();
                    } else {
                        showNotification(result.error || 'Failed to clear history', 'error');
                    }
                } catch (error) {
                    showNotification('Error clearing history', 'error');
                }
            }
        });
        
        // Filter functionality
        const applyFilterBtn = document.getElementById('applyFilter');
        const clearFilterBtn = document.getElementById('clearFilter');
        
        applyFilterBtn.addEventListener('click', async () => {
            const cityFilter = document.getElementById('cityFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            try {
                const params = new URLSearchParams();
                if (cityFilter) params.append('city', cityFilter);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                
                const response = await fetch(`/filter_history?${params}`);
                const data = await response.json();
                
                updateHistoryTableWithData(data);
                showNotification('🔍 Filter applied successfully!', 'success');
            } catch (error) {
                showNotification('Error applying filter', 'error');
            }
        });
        
        clearFilterBtn.addEventListener('click', () => {
            document.getElementById('cityFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            updateHistoryTable();
            showNotification('🔍 Filter cleared', 'info');
        });
        
        function updateHistoryTableWithData(data) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            data.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.city}</td>
                    <td>${entry.temperature}</td>
                    <td>${entry.humidity}</td>
                    <td>${entry.wind_speed}</td>
                    <td>${entry.date}</td>
                    <td>${entry.time}</td>
                    <td>${entry.description || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Graph generation
        const generateGraphBtn = document.getElementById('generateGraphBtn');
        const graphContainer = document.getElementById('graphContainer');
        const graphPlaceholder = document.getElementById('graphPlaceholder');
        
        generateGraphBtn.addEventListener('click', async () => {
            const parameter = document.getElementById('graphParameter').value;
            
            showLoading(true);
            
            try {
                const response = await fetch(`/generate_graph?parameter=${parameter}`);
                const result = await response.json();
                
                if (result.success) {
                    graphPlaceholder.style.display = 'none';
                    graphContainer.innerHTML = `
                        <img src="data:image/png;base64,${result.graph}" alt="Weather Graph" class="weather-graph">
                    `;
                } else {
                    showNotification(result.error || 'Failed to generate graph', 'error');
                }
            } catch (error) {
                showNotification('Error generating graph', 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // Utility functions
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        
        function showNotification(message, type = 'info') {
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Close notification
        document.getElementById('notificationClose').addEventListener('click', () => {
            notification.classList.remove('show');
        });
        
        // Map functionality
        let weatherMap = null;
        let mapMarkers = [];
        let cityCoordinates = new Map(); // Cache for city coordinates
        let lastSearchedCity = null; // Store the last searched city
        
        function initMap() {
            if (weatherMap) {
                weatherMap.remove();
            }
            
            // Default to India center (since you mentioned Kolkata and Barasat)
            weatherMap = L.map('weatherMap').setView([22.5726, 88.3639], 6); // Kolkata coordinates as default
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(weatherMap);
            
            updateMap();
        }
        
        async function getCityCoordinates(cityName) {
            // Check cache first
            if (cityCoordinates.has(cityName)) {
                return cityCoordinates.get(cityName);
            }
            
            try {
                const response = await fetch(`/get_city_coordinates?city=${encodeURIComponent(cityName)}`);
                const result = await response.json();
                
                if (result.success) {
                    const coords = result.coordinates;
                    cityCoordinates.set(cityName, coords);
                    return coords;
                } else {
                    console.error('Error getting coordinates for', cityName, result.error);
                    showNotification(`📍 Could not find coordinates for ${cityName}`, 'warning');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching coordinates for', cityName, error);
                showNotification(`📍 Error getting location for ${cityName}`, 'error');
                return null;
            }
        }
        
        async function updateMap() {
            if (!weatherMap) return;
            
            // Clear existing markers
            mapMarkers.forEach(marker => weatherMap.removeLayer(marker));
            mapMarkers = [];
            
            try {
                const response = await fetch('/get_history');
                const data = await response.json();
                
                if (data.length > 0) {
                    const cities = [...new Set(data.map(entry => entry.city))];
                    let bounds = [];
                    let validCoordinates = [];
                    
                    // Get coordinates for each unique city
                    for (const city of cities) {
                        const coords = await getCityCoordinates(city);
                        if (coords) {
                            const marker = L.marker([coords.lat, coords.lon]).addTo(weatherMap);
                            const recordCount = data.filter(entry => entry.city === city).length;
                            
                            marker.bindPopup(`
                                <div style="text-align: center;">
                                    <strong>📍 ${coords.name}</strong><br>
                                    ${coords.state ? coords.state + ', ' : ''}${coords.country}<br>
                                    <hr style="margin: 5px 0;">
                                    📊 <strong>${recordCount}</strong> weather records<br>
                                    🌡️ Latest: ${data.find(entry => entry.city === city)?.temperature}°C
                                </div>
                            `);
                            
                            mapMarkers.push(marker);
                            bounds.push([coords.lat, coords.lon]);
                            validCoordinates.push(coords);
                        }
                    }
                    
                    // Fit map to show all markers
                    if (bounds.length > 0) {
                        if (bounds.length === 1) {
                            // If only one location, center on it with appropriate zoom
                            weatherMap.setView(bounds[0], 10);
                        } else {
                            // If multiple locations, fit bounds to show all
                            weatherMap.fitBounds(bounds, { padding: [20, 20] });
                        }
                    }
                } else {
                    // No data, show default view (India)
                    weatherMap.setView([22.5726, 88.3639], 6);
                }
            } catch (error) {
                console.error('Error updating map:', error);
            }
        }
        
        // Function to center map on a specific city
        async function centerMapOnCity(cityName) {
            if (!weatherMap) return;
            
            const coords = await getCityCoordinates(cityName);
            if (coords) {
                weatherMap.setView([coords.lat, coords.lon], 10);
                
                // Add a special marker for the current city
                const currentMarker = L.marker([coords.lat, coords.lon], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<div style="background-color: #007bff; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">📍</div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(weatherMap);
                
                currentMarker.bindPopup(`
                    <div style="text-align: center;">
                        <strong>🎯 Current Location</strong><br>
                        📍 ${coords.name}<br>
                        ${coords.state ? coords.state + ', ' : ''}${coords.country}
                    </div>
                `).openPopup();
                
                mapMarkers.push(currentMarker);
            }
        }
        
        // Map refresh button
        const refreshMapBtn = document.getElementById('refreshMapBtn');
        refreshMapBtn.addEventListener('click', () => {
            updateMap();
            showNotification('🗺️ Map refreshed!', 'success');
        });
        
        // Center map button
        const centerMapBtn = document.getElementById('centerMapBtn');
        centerMapBtn.addEventListener('click', async () => {
            if (lastSearchedCity) {
                await centerMapOnCity(lastSearchedCity);
                showNotification(`🎯 Map centered on ${lastSearchedCity}!`, 'success');
            } else {
                showNotification('📍 No city searched yet. Please search for a city first.', 'info');
            }
        });
        
        // Initialize map when map section is accessed
        document.querySelector('a[href="#map"]').addEventListener('click', () => {
            setTimeout(() => {
                if (!weatherMap) {
                    initMap();
                }
            }, 100);
        });
        
    </script>
</body>
</html>
